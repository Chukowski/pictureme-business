version: "3.9"

services:
  imgproxy:
    image: darthsim/imgproxy:latest
    networks:
      - dokploy-network
    
    # DNS p√∫blico para resolver nombres (R2, fal.media, etc.)
    dns:
      - 8.8.8.8
      - 1.1.1.1
    
    deploy:
      mode: replicated
      replicas: 3
      placement:
        constraints:
          - node.role == manager

    volumes:
      - imgproxy-cache:/imgproxy/cache
    
    environment:
      IMGPROXY_BIND: ":8080"

      # ===== Sources - CRITICAL =====
      # Usando "*" para permitir TODAS las URLs (R2, S3, fal.media, etc.)
      # Sin esta variable, imgproxy rechaza con "Invalid source URL"
      IMGPROXY_ALLOWED_SOURCES: "*"
      
      # ===== Persistent CACHE =====
      IMGPROXY_CACHE: "true"
      IMGPROXY_CACHE_DIR: "/imgproxy/cache"
      IMGPROXY_CACHE_SIZE: "10000"
      IMGPROXY_CACHE_CONTROL_PUBLIC: "true"
      IMGPROXY_CACHE_CONTROL_MAX_AGE: "31536000"
      IMGPROXY_SET_AS_IMMUTABLE: "true"
      IMGPROXY_USE_ETAG: "true"
      IMGPROXY_USE_LAST_MODIFIED: "true"

      # ===== Performance =====
      IMGPROXY_CONCURRENCY: "50"
      IMGPROXY_MAX_CLIENTS: "2048"
      IMGPROXY_MAX_SRC_RESOLUTION: "50"
      IMGPROXY_TIMEOUT: "30"
      IMGPROXY_DOWNLOAD_TIMEOUT: "20"

      # ===== Formats =====
      IMGPROXY_AUTO_WEBP: "true"
      IMGPROXY_AUTO_AVIF: "true"
      IMGPROXY_PREFERRED_FORMATS: "avif,webp,jpeg,png"
      
      # ===== Client Hints =====
      IMGPROXY_ENABLE_WEBP_DETECTION: "true"
      IMGPROXY_ENABLE_CLIENT_HINTS: "true"

volumes:
  imgproxy-cache:

networks:
  dokploy-network:
    external: true
